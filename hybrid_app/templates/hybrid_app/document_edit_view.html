{% extends "hybrid_app/base.html" %}

{% block content %}
  <div id="app">
    <div id="tools">
      <p><a href="{% url 'hybrid_app:document_list_view' %}">&larr; Documents</a></p>
      <p>{{ document.name }}</p>
      <block-form @block-added="onAddBlock"></block-form>
    </div>
    <hr />
    <div id="blocks">
      <block-item
        v-for="item in blocks"
        v-bind:block="item"
        v-bind:key="item.id"
      >
      </block-item>
    </div>
  </div>

  <div id="paintApp" b-bind:style="{cursor: paintCursor}">
     <canvas @mousedown="startPainting" @mouseup="finishedPainting" @mousemove="draw"  id="canvas" v-bind:style="{cursor: paintCursor}"></canvas>
  </div>

  <script>
    var defaultContent = "Empty"
    const app = Vue.createApp({
      data() {
        return {
          blocks: null,
        }
      },
      mounted() {
        var vm = this;
        axios
          .get('../api/block-edit/' + {{ pk }})
          .then(response => {
            this.blocks = response.data
          })
      },
      methods: {
        onAddBlock(block) {
          axios
            .post('../api/block-edit/' + {{ pk }},
              {
                type: block.type,
                content: defaultContent
              },
              {
                headers: {'X-CSRFToken' : getCookie('csrftoken')}
              }
            )
            .then(response => {
              this.blocks.push(response.data)
            })
        },
      }
    })

    app.component('block-item', {
      delimiters: ["[[", "]]"],
      props: ['block', 'graph'],
      template: `
        <h4>[[ block.type ]]</h4>
        <template v-if="block.type=='Text'">
          <textarea
            v-if="block.edit"
            v-model="block.content"
            @blur="block.edit=false; updateContent(block.id, block.content);"
          >
          </textarea>
          <div v-else>
            <p @click="block.edit=true;">
              [[ block.content ]]
            </p>
          </div>
        </template>
        <template v-if="block.type=='Graph'">
          <div
            v-if="block.edit"
            @click="block.edit=false; updateContent(block.id, block.content);"
          >
            [[ block.content ]]
          </div>

          <div
            v-else
            @click="block.edit=true;"
          >
            <canvas :id="'graph-' + block.id" ref="graph"></canvas>
          </div>
        </template>
      `,
      methods: {
        updateContent: function (id, content) {
          axios
            .patch('../api/blocks/' + id + "/",
              {
                content: content
              },
              {
                headers: {'X-CSRFToken' : getCookie('csrftoken')}
              }
            );
        }
      },
      mounted() {
        if (this.block.type=='Graph') {
          console.log(this.block.id);
          var c = this.$el;
          console.log(c);
          var c = this.$refs.graph;
          console.log(c);
          var ctx = c.getContext('2d');
          console.log(ctx);

          console.log(this.block.content);

          var canvas = new fabric.Canvas(String('graph-' + this.block.id));
          canvas.loadFromJSON(this.block.content);
        }
      }
    })

    app.component('block-form', {
      delimiters: ["[[", "]]"],
      template: `
        <form class="block-form" @submit.prevent="onAddBlock">
          <h3>Add block</h3>
          <label for="type">Type</label>
          <select id="type" v-model="type">
            <option>Graph</option>
            <option>Equation</option>
            <option>Text</option>
            <option>Image</option>
          </select>
          <input class="button" type="submit" value="Add">
        </form>
      `,
      data() {
        return {
          type: ''
        }
      },
      methods: {
        onAddBlock() {
          let newBlock = {
            type: this.type,
            content: defaultContent
          }
          this.$emit('block-added', newBlock)
          this.type = ''
        }
      }
    })

    app.mount('#app')
  </script>

  <script>
    var height = 400;
    var width = 600;

    const paintApp = Vue.createApp({
      data() {
        return {
          vueCanvas: null,
          painting: false,
          canvas: null,
          ctx: null,
          paintCursor: 'crosshair'
        }
      },
      methods: {
        startPainting(e) {
          this.painting = true;
          this.draw(e)
        },
        finishedPainting() {
          this.painting = false;
          this.ctx.beginPath()
        },
        draw(e) {
          if(!this.painting) return

          this.ctx.lineWidth = 3;
          this.ctx.lineCap ="round"

          this.ctx.lineTo(e.clientX - (canvas.offsetLeft - window.pageXOffset),e.clientY - (canvas.offsetTop - window.pageYOffset))
          this.ctx.stroke()

          this.ctx.beginPath()
          this.ctx.moveTo(e.clientX - (canvas.offsetLeft - window.pageXOffset),e.clientY - (canvas.offsetTop - window.pageYOffset))
        }
      },
      mounted() {
        this.canvas = document.getElementById("canvas");
        this.ctx = canvas.getContext("2d");
        this.canvas.height = height;
        this.canvas.width = width;
        this.canvas.style.border = '1px solid black';
      }
    })

    paintApp.mount('#paintApp')
  </script>

{% endblock %}
