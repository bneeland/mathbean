{% extends "hybrid_app/base.html" %}

{% block content %}
  <div id="app">
    <div id="tools">
      <p><a href="{% url 'hybrid_app:document_list_view' %}">&larr; Documents</a></p>
      <div
        v-if="editingMode"
      >
        <input
          ref="input"
          v-model="document.name"
          @blur="editingMode=false; updateContent(document.id, document.name);"
          @keyup.enter="editingMode=false; updateContent(document.id, document.name);"
        />
      </div>
      <div v-else>
        <h1
          @click="switchToEditingMode();" style="cursor: pointer"
        >
          [[ document.name ]]
        </h1>
      </div>
      <block-form @block-added="onAddBlock"></block-form>
    </div>
    <hr />
    <div id="blocks">
      <block-item
        v-for="item in blocks"
        v-bind:block="item"
        v-bind:key="item.id"
      >
      </block-item>
    </div>
  </div>

  <script>
    var defaultContent = "New block"

    const app = Vue.createApp({
      delimiters: ["[[", "]]"],
      data() {
        return {
          blocks: null,
          document: "",
          editingMode: false,
        }
      },
      mounted() {
        var vm = this;
        axios
          .get('../api/block-edit/' + {{ pk }})
          .then(response => {
            this.blocks = response.data
          });
        axios
          .get('../api/documents/' + {{ pk }})
          .then(response => {
            this.document = response.data
          });
      },
      methods: {
        onAddBlock(block) {
          axios
            .post('../api/block-edit/' + {{ pk }},
              {
                type: block.type,
                content: defaultContent
              },
              {
                headers: {'X-CSRFToken' : getCookie('csrftoken')}
              }
            )
            .then(response => {
              this.blocks.push(response.data)
            })
        },
        switchToEditingMode: function () {
          this.editingMode = true;
          this.$nextTick(() => {
            this.focusOnInput();
          })
        },
        focusOnInput: function () {
          this.$refs.input.focus();
        },
        updateContent: function (id, name) {
          axios
            .patch('../api/documents/' + id + "/",
              {
                name: name
              },
              {
                headers: {'X-CSRFToken' : getCookie('csrftoken')}
              }
            );
        },
      }
    })

    app.component('block-item', {
      delimiters: ["[[", "]]"],
      props: ['block', 'graph'],
      template: `
        <div class="block" style="border: 1px solid lightgrey; margin-bottom: 20px;">
          <h4>[[ block.type ]]</h4>
          <div><button @click="deleteBlock(block.id)">Delete block</button></div>
          <template v-if="block.type=='Text'">
            <textarea
              ref="textarea"
              v-if="editingMode"
              v-model="block.content"
              @blur="editingMode=false; updateContent(block.id, block.content);"
            >
            </textarea>
            <div v-else>
              <p @click="switchToEditingMode();" style="cursor: pointer">
                [[ block.content ]]
              </p>
            </div>
          </template>
          <template v-if="block.type=='Graph'">
            <div @mouseout="updateContent(block.id, updateContentGraph(block.id));">
              <button @click="toggleDrawing(block.id)">Drawing: [[ drawingMode ]]</button>
              <button @click="deleteSelected(block.id)">Delete</button>
              <canvas :id="'graph-'+block.id" ref="graph" style="border: 1px solid grey"></canvas>
            </div>
          </template>
          <template v-if="block.type=='Image'">
            <div>
              <img :src="block.image" style="display: inline-block; max-width:500px;">
            </div>
            <div>
              <input type="file" @change="onFileSelected">
              <button @click="onUpload(block.id);">Upload</button>
            </div>
          </template>
        </div>
      `,
      data() {
        return {
          editingMode: false,
          drawingMode: false,
          selectedFile: null,
        }
      },
      methods: {
        switchToEditingMode: function () {
          this.editingMode = true;
          this.$nextTick(() => {
            this.focusOnTextarea();
          })
        },
        focusOnTextarea: function () {
          this.$refs.textarea.focus();
        },
        updateContent: function (id, content) {
          axios
            .patch('../api/blocks/' + id + "/",
              {
                content: content
              },
              {
                headers: {'X-CSRFToken' : getCookie('csrftoken')}
              }
            );
        },
        updateContentGraph: function (id) {
          var canvas = document.getElementById("graph-" + id).fabric;
          canvasJSON = JSON.stringify(canvas);
          return canvasJSON;
        },
        toggleDrawing: function (id) {
          var canvas = document.getElementById("graph-" + id).fabric;
          if (canvas.isDrawingMode === false) {
            canvas.isDrawingMode = true;
            this.drawingMode = true;
          } else {
            canvas.isDrawingMode = false;
            this.drawingMode = false;
          }
        },
        deleteSelected: function (id) {
          var canvas = document.getElementById("graph-" + id).fabric;
          canvas.getActiveObjects().forEach((obj) => {
            canvas.remove(obj)
          });
        },
        onFileSelected(event) {
          this.selectedFile = event.target.files[0];
        },
        onUpload: function (id) {
          const formData = new FormData();
          formData.append('image', this.selectedFile, 'bear.png');
          axios({
            method: 'patch',
            url: '../api/blocks/' + id + "/",
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'multipart/form-data'
            },
            data: formData
          })
          .then(response => {
            this.block.image = response.data.image;
          })
        },
        deleteBlock: function (id) {
          axios
            .delete('../api/blocks/' + id + '/',
              {
                headers: {'X-CSRFToken' : getCookie('csrftoken')}
              }
            )
            .then(response => {
              console.log('This should make block removed from blocks array')
            });
        },
      },
      mounted() {
        if (this.block.type=='Graph') {
          // Delete this?
          var c = this.$el;
          var c = this.$refs.graph;
          var ctx = c.getContext('2d');
          // Delete this? ^

          var width = 600;
          var height = 400;

          var canvas = new fabric.Canvas(String('graph-' + this.block.id));
          canvas.setDimensions({width:width, height:height});
          canvas.add(new fabric.Line([0, height/2, width, height/2], {
            left: 0,
            top: 200,
            stroke: 'black',
            lockMovementX: true,
            lockMovementY: true,
            evented: false,
            hasControls: false,
            hasBorders: false,
            selectable: false,
          }));
          canvas.add(new fabric.Line([width/2, 0, width/2, height], {
            left: 300,
            top: 0,
            stroke: 'black',
            lockMovementX: true,
            lockMovementY: true,
            evented: false,
            hasControls: false,
            hasBorders: false,
            selectable: false,
          }));

          document.getElementById("graph-" + this.block.id).fabric = canvas;
          if (this.block.content != "Empty") {
            canvas.loadFromJSON(this.block.content);
          }
        }
      }
    })

    app.component('block-form', {
      delimiters: ["[[", "]]"],
      emits: ['block-added'],
      template: `
        <h3>Add block</h3>
        <label for="type">Type</label>
        <select id="type" v-model="type" @change="onAddBlock">
          <option></option>
          <option>Graph</option>
          <option>Equation</option>
          <option>Text</option>
          <option>Image</option>
        </select>
      `,
      data() {
        return {
          type: ''
        }
      },
      methods: {
        onAddBlock() {
          let newBlock = {
            type: this.type,
            content: defaultContent
          }
          this.$emit('block-added', newBlock)
          this.type = ''
        }
      }
    })

    app.mount('#app')
  </script>

{% endblock %}
